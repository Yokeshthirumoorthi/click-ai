services:

  # ─── Session ClickHouse (per-session data, part-shipped from master) ──
  clickhouse-session:
    image: clickhouse/clickhouse-server:latest
    container_name: clickhouse-session
    restart: unless-stopped
    ports:
      - "8124:8123"
      - "9001:9000"
    volumes:
      - clickhouse-session-data:/var/lib/clickhouse
      - ./config/session-clickhouse-config.xml:/etc/clickhouse-server/config.d/custom.xml:ro
      - ./config/session-clickhouse-users.xml:/etc/clickhouse-server/users.d/custom.xml:ro
    environment:
      CLICKHOUSE_DB: otel
      CLICKHOUSE_USER: ${CH_USER:-admin}
      CLICKHOUSE_PASSWORD: ${CH_PASSWORD:-clickhouse123}
      CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT: 1
    ulimits:
      nofile:
        soft: 262144
        hard: 262144
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8123/ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    profiles:
      - agent

  # ─── Analysis Platform ─────────────────────────────────────────
  platform:
    build:
      context: .
    container_name: click-ai-platform
    ports:
      - "3000:8000"
    environment:
      CH_HOST: ${CH_HOST:-clickhouse}
      CH_PORT: ${CH_PORT:-8123}
      CH_USER: ${CH_USER:-admin}
      CH_PASSWORD: ${CH_PASSWORD:-clickhouse123}
      CH_DATABASE: ${CH_DATABASE:-otel}
      SESSION_CH_HOST: ${SESSION_CH_HOST:-clickhouse-session}
      SESSION_CH_PORT: ${SESSION_CH_PORT:-8123}
      SESSION_CH_USER: ${SESSION_CH_USER:-admin}
      SESSION_CH_PASSWORD: ${SESSION_CH_PASSWORD:-clickhouse123}
      OPENROUTER_API_KEY: "${OPENROUTER_API_KEY}"
      OPENROUTER_BASE_URL: ${OPENROUTER_BASE_URL:-https://openrouter.ai/api/v1}
      LLM_MODEL: ${LLM_MODEL:-anthropic/claude-sonnet-4}
      AUTH_SECRET: ${AUTH_SECRET:-change-me-in-production}
      AUTH_USERNAME: ${AUTH_USERNAME:-admin}
      AUTH_PASSWORD: ${AUTH_PASSWORD:-admin}
    volumes:
      - clickhouse-data:/master-ch-data:ro
      - clickhouse-session-data:/session-ch-data
    depends_on:
      clickhouse:
        condition: service_healthy
      clickhouse-session:
        condition: service_healthy
    profiles:
      - agent

volumes:
  clickhouse-session-data:
