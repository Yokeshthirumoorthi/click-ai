services:

  # ─── ClickHouse ───────────────────────────────────────────────────
  clickhouse:
    image: clickhouse/clickhouse-server:latest
    container_name: clickhouse
    restart: unless-stopped
    ports:
      - "8123:8123"
      - "9000:9000"
    volumes:
      - clickhouse-data:/var/lib/clickhouse
      - clickhouse-logs:/var/log/clickhouse-server
      - ./config/clickhouse-config.xml:/etc/clickhouse-server/config.d/custom.xml:ro
      - ./config/clickhouse-users.xml:/etc/clickhouse-server/users.d/custom.xml:ro
      - ./config/init-db.sql:/docker-entrypoint-initdb.d/init-db.sql:ro
    environment:
      CLICKHOUSE_DB: default
      CLICKHOUSE_USER: admin
      CLICKHOUSE_PASSWORD: clickhouse123
      CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT: 1
    ulimits:
      nofile:
        soft: 262144
        hard: 262144
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8123/ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ─── OTEL Collector ───────────────────────────────────────────────
  otel-collector:
    image: otel/opentelemetry-collector-contrib:latest
    container_name: otel-collector
    restart: unless-stopped
    ports:
      - "4317:4317"   # gRPC — your app sends here
      - "4318:4318"   # HTTP — alternative
    volumes:
      - ./config/otel-collector-config.yaml:/etc/otelcol-contrib/config.yaml:ro
    environment:
      AWS_ACCESS_KEY_ID: minioadmin
      AWS_SECRET_ACCESS_KEY: minioadmin
    depends_on:
      clickhouse:
        condition: service_healthy
      minio-init:
        condition: service_completed_successfully

  # ─── MongoDB ──────────────────────────────────────────────────────
  mongodb:
    image: mongo:6.0
    container_name: mongodb
    restart: unless-stopped
    volumes:
      - mongodb-data:/data/db
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ─── HyperDX UI ───────────────────────────────────────────────────
  hyperdx:
    image: docker.hyperdx.io/hyperdx/hyperdx:latest
    container_name: hyperdx
    restart: unless-stopped
    ports:
      - "8080:8080"
      - "8000:8000"
    environment:
      MONGO_URI: "mongodb://mongodb:27017/hyperdx"
      FRONTEND_URL: "http://localhost:8080"
      SERVER_URL: "http://localhost:8000"
      HYPERDX_API_PORT: "8000"
      HYPERDX_APP_PORT: "8080"
      USAGE_STATS_ENABLED: "false"
      DEFAULT_CONNECTIONS: >-
        [{"name":"ClickHouse Local",
          "host":"http://clickhouse:8123",
          "username":"admin",
          "password":"clickhouse123"}]
    depends_on:
      clickhouse:
        condition: service_healthy
      mongodb:
        condition: service_healthy

  # ─── MinIO (simulates customer's S3 bucket) ─────────────────────
  minio:
    image: minio/minio
    container_name: minio
    restart: unless-stopped
    ports:
      - "9002:9000"    # S3 API
      - "9001:9001"    # Console UI
    volumes:
      - minio-data:/data
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    command: server /data --console-address ":9001"
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ─── MinIO bucket init ──────────────────────────────────────────
  minio-init:
    image: minio/mc
    container_name: minio-init
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
      mc alias set local http://minio:9000 minioadmin minioadmin &&
      mc mb --ignore-existing local/traces &&
      echo 'Bucket traces created'
      "
    restart: "no"

  # ─── Event Generator ─────────────────────────────────────────────
  event-generator:
    build:
      context: ./event-generator
    container_name: event-generator
    restart: unless-stopped
    environment:
      OTEL_EXPORTER_OTLP_ENDPOINT: "http://otel-collector:4317"
      EVENTS_PER_SECOND: "5"
    depends_on:
      - otel-collector

  # ─── S3 Loader ───────────────────────────────────────────────────
  s3-loader:
    build:
      context: ./s3-loader
    container_name: s3-loader
    restart: unless-stopped
    environment:
      S3_ENDPOINT: "http://minio:9000"
      S3_ACCESS_KEY: minioadmin
      S3_SECRET_KEY: minioadmin
      S3_BUCKET: traces
      S3_PREFIX: "incoming/"
      CH_HOST: clickhouse
      CH_USER: admin
      CH_PASSWORD: clickhouse123
      CH_DATABASE: otel
      POLL_INTERVAL: "10"
    depends_on:
      clickhouse:
        condition: service_healthy
      minio-init:
        condition: service_completed_successfully

  # ─── Embedding Enricher ─────────────────────────────────────────
  embedding-enricher:
    build:
      context: ./embedding-enricher
    container_name: embedding-enricher
    restart: unless-stopped
    environment:
      CH_HOST: clickhouse
      CH_USER: admin
      CH_PASSWORD: clickhouse123
      CH_DATABASE: otel
      POLL_INTERVAL: "15"
      BATCH_SIZE: "256"
    depends_on:
      clickhouse:
        condition: service_healthy

volumes:
  clickhouse-data:
  clickhouse-logs:
  mongodb-data:
  minio-data:
