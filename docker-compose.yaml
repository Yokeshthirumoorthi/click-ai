services:

  # ─── ClickHouse ───────────────────────────────────────────────────
  clickhouse:
    image: clickhouse/clickhouse-server:latest
    container_name: clickhouse
    restart: unless-stopped
    ports:
      - "8123:8123"
      - "9000:9000"
    volumes:
      - clickhouse-data:/var/lib/clickhouse
      - clickhouse-logs:/var/log/clickhouse-server
      - ./config/clickhouse-config.xml:/etc/clickhouse-server/config.d/custom.xml:ro
      - ./config/clickhouse-users.xml:/etc/clickhouse-server/users.d/custom.xml:ro
    environment:
      CLICKHOUSE_DB: default
      CLICKHOUSE_USER: admin
      CLICKHOUSE_PASSWORD: clickhouse123
      CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT: 1
    ulimits:
      nofile:
        soft: 262144
        hard: 262144
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8123/ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ─── OTEL Collector ───────────────────────────────────────────────
  otel-collector:
    image: otel/opentelemetry-collector-contrib:latest
    container_name: otel-collector
    restart: unless-stopped
    ports:
      - "4317:4317"   # gRPC — your app sends here
      - "4318:4318"   # HTTP — alternative
    volumes:
      - ./config/otel-collector-config.yaml:/etc/otelcol-contrib/config.yaml:ro
    depends_on:
      clickhouse:
        condition: service_healthy

  # ─── MongoDB ──────────────────────────────────────────────────────
  mongodb:
    image: mongo:6.0
    container_name: mongodb
    restart: unless-stopped
    volumes:
      - mongodb-data:/data/db
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ─── HyperDX UI ───────────────────────────────────────────────────
  hyperdx:
    image: docker.hyperdx.io/hyperdx/hyperdx:latest
    container_name: hyperdx
    restart: unless-stopped
    ports:
      - "8080:8080"
      - "8000:8000"
    environment:
      MONGO_URI: "mongodb://mongodb:27017/hyperdx"
      FRONTEND_URL: "http://localhost:8080"
      SERVER_URL: "http://localhost:8000"
      HYPERDX_API_PORT: "8000"
      HYPERDX_APP_PORT: "8080"
      USAGE_STATS_ENABLED: "false"
      DEFAULT_CONNECTIONS: >-
        [{"name":"ClickHouse Local",
          "host":"http://clickhouse:8123",
          "username":"admin",
          "password":"clickhouse123"}]
    depends_on:
      clickhouse:
        condition: service_healthy
      mongodb:
        condition: service_healthy

  # ─── Event Generator ─────────────────────────────────────────────
  event-generator:
    build:
      context: ./event-generator
    container_name: event-generator
    restart: unless-stopped
    environment:
      OTEL_EXPORTER_OTLP_ENDPOINT: "http://otel-collector:4317"
      EVENTS_PER_SECOND: "5"
    depends_on:
      - otel-collector

volumes:
  clickhouse-data:
  clickhouse-logs:
  mongodb-data:
