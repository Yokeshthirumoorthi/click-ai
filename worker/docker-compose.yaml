services:

  # ─── S3 Loader ────────────────────────────────────────────────────
  s3-loader:
    build:
      context: ./s3-loader
    container_name: s3-loader
    restart: unless-stopped
    environment:
      S3_ENDPOINT: ${S3_ENDPOINT:-http://minio:9000}
      S3_ACCESS_KEY: ${S3_ACCESS_KEY:-minioadmin}
      S3_SECRET_KEY: ${S3_SECRET_KEY:-minioadmin}
      S3_BUCKET: ${S3_BUCKET:-traces}
      S3_TRACES_PREFIX: ${S3_TRACES_PREFIX:-incoming/}
      S3_METRICS_PREFIX: ${S3_METRICS_PREFIX:-metrics/}
      S3_LOGS_PREFIX: ${S3_LOGS_PREFIX:-logs/}
      CH_HOST: ${CH_HOST:-clickhouse}
      CH_USER: ${CH_USER:-admin}
      CH_PASSWORD: ${CH_PASSWORD:-clickhouse123}
      CH_DATABASE: ${CH_DATABASE:-otel}
      BATCH_SIZE: "50000"
      MAX_FILE_WORKERS: "16"
    depends_on:
      clickhouse:
        condition: service_healthy
      minio-init:
        condition: service_completed_successfully

  # ─── Embedding Enricher ───────────────────────────────────────────
  embedding-enricher:
    build:
      context: ./embedding-enricher
    container_name: embedding-enricher
    restart: unless-stopped
    environment:
      CH_HOST: ${CH_HOST:-clickhouse}
      CH_USER: ${CH_USER:-admin}
      CH_PASSWORD: ${CH_PASSWORD:-clickhouse123}
      CH_DATABASE: ${CH_DATABASE:-otel}
      POLL_INTERVAL: "1"
      BATCH_SIZE: "4096"
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    depends_on:
      clickhouse:
        condition: service_healthy
